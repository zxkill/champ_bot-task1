# Автономная навигация робота Webots по узким коридорам

Проект демонстрирует устойчивую навигацию дифференциального робота в лабиринте Webots:
скрипт автоматически обнаруживает проходы по данным лидара, выравнивается по центру коридора и
быстро проводит робота через узкие участки. Такой подход одинаково полезен для
SEO-запросов вроде *Webots corridor navigation*, *lidar corridor detection* и *autonomous maze driving*.

## Ключевые возможности

- **Поиск проходов**: модуль `tools.py` разбирает lidar-облако и оценивает ширину доступных коридоров.
- **Плавное следование**: класс `CorridorFollower` формирует линейные и угловые скорости с учётом ограничений ускорений.
- **Мгновенное применение команд**: `demo.py` отправляет рассчитанные `v` и `w` напрямую в контроллер, благодаря чему робот не "задумывается" и уверенно входит в найденный проём.
- **Подробное логирование**: все шаги снабжены русскоязычными сообщениями для удобной диагностики.
- **Тестовое покрытие**: в репозитории присутствуют модульные тесты, проверяющие геометрию коридоров и корректность управления.
- **Гистерезис ширины проёма**: параметр `width_tolerance` в `corridor_fits` компенсирует шум лидара, чтобы коридоры не «пропадали» во время манёвра.

## Подготовка окружения

1. Установите **Webots v.R2025a** (актуальная стабильная версия): [https://cyberbotics.com/#download](https://cyberbotics.com/#download).
2. Клонируйте репозиторий `https://git.robot.cybertech.ai/champ_bot/task1`.
3. Установите зависимости Python (при необходимости):
   ```bash
   pip install -r requirements.txt
   ```

## Запуск симуляции лабиринта

Главный мир: `worlds/cobra_flex_demo.wbt`. После открытия Webots автоматически поднимет контроллер `udp_diff`,
который слушает команды на `127.0.0.1:5555/UDP` и отдаёт телеметрию на `127.0.0.1:5600/TCP или UDP`.

Команды запуска для популярных платформ:

- **macOS**
  ```bash
  /Applications/Webots.app/Contents/MacOS/webots --stdout --stderr ./worlds/cobra_flex_demo.wbt
  ```
- **Windows**
  ```bash
  "C:\\Program Files\\Webots\\webots.exe" --stdout --stderr .\\worlds\\cobra_flex_demo.wbt
  ```
- **Linux**
  ```bash
  /webots/webots --stdout --stderr ./worlds/cobra_flex_demo.wbt
  ```
  или
  ```bash
  snap run webots --stdout --stderr ./worlds/cobra_flex_demo.wbt
  ```

## Запуск клиента навигации

1. Убедитесь, что симуляция уже идёт и контроллер `udp_diff` загружен.
2. Выполните:
   ```bash
   python demo.py
   ```
3. В терминале появятся сообщения вида `Коридор (i0, i1) ... -> команды: v=..., w=...`. Робот начнёт уверенно проходить найденный коридор.

Клиент использует протокол UDP для команд и автоматически восстанавливает движение при появлении нового безопасного прохода.
Дополнительно включено отладочное сообщение, если коридор отвергается из-за недостаточной ширины или глубины — это помогает быстро понять, почему робот остановился.
При необходимости можно подобрать величину допущения через переменную окружения `WIDTH_TOLERANCE` (значение в метрах, по умолчанию 0.02).

## Формат обмена данными

- **Команда движения** — два числа `float32` (`linear_x`, `angular_z`) в формате little-endian, отправляются на `127.0.0.1:5555/UDP`.
- **Телеметрия** — заголовок `b"WBTG"`, затем девять значений `float32` (одометрия, скорости, гироскоп) и массив расстояний лидара.

Пример отправки команды на Python:

```python
import socket, struct

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
packet = struct.pack("<2f", 0.3, 0.0)  # ехать вперёд 0.3 м/с без поворота
sock.sendto(packet, ("127.0.0.1", 5555))
```

## Тестирование

Проект сопровождается автотестами. Для быстрой проверки того, что алгоритм поиска и прохода через коридор работает корректно, выполните:

```bash
pytest --cov
```

Рекомендуется запускать тесты перед каждым коммитом — так проще отслеживать регрессии и поддерживать высокое покрытие.
